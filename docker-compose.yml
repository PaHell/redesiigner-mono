version: '3.9'

services:

  db_redis:
    container_name: db_redis
    image: redis:${REDIS_VERSION}
    environment:
      - name=value
    ports:
      - ${REDIS_PORT}:6379
    networks:
      - redis
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - ./redis.conf:/usr/local/etc/redis/redis.conf
    restart: always

  db_mongo:
    container_name: db_mongo
    image: mongo:${MONGO_VERSION}
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD}
      - MONGO_INITDB_DATABASE=admin
    ports:
      - ${MONGO_PORT}:27017
    networks:
      - mongo
    volumes:
      - ./mongodb/mongod.conf:/etc/mongod.conf:r
      - ./mongodb/data:/data/db:rw
      - ./mongodb/logs:/var/log/mongodb:rw
    command: ["-f", "/etc/mongod.conf"]
    env_file:
      - .env
    restart: always

  db_mongo_express:
    depends_on:
      - db_mongo
      # heaviest service, so it starts last
      - api_go_fiber
    container_name: db_mongo_express
    image: mongo-express:${MONGO_EXPRESS_VERSION}
    ports:
      - ${MONGO_EXPRESS_PORT}:8081
    networks:
      - mongo
    environment:
      - ME_CONFIG_MONGODB_SERVER=db_mongo
      - ME_CONFIG_MONGODB_PORT=${MONGO_PORT}
      - ME_CONFIG_MONGODB_ENABLE_ADMIN=true
      - ME_CONFIG_MONGODB_AUTH_DATABASE=admin
      - ME_CONFIG_MONGODB_AUTH_USERNAME=${MONGO_ROOT_USERNAME}
      - ME_CONFIG_MONGODB_AUTH_PASSWORD=${MONGO_ROOT_PASSWORD}
      - ME_CONFIG_BASICAUTH_USERNAME=${MONGO_EXPRESS_USERNAME}
      - ME_CONFIG_BASICAUTH_PASSWORD=${MONGO_EXPRESS_PASSWORD}
    restart: always

  api_go_fiber:
    depends_on:
      - db_mongo
      - db_redis
    container_name: api_go_fiber
    build: ./go_fiber
    environment:
      - MONGODB_CONNECTION_STRING=\
        mongodb:\\${MONGO_ROOT_USERNAME}:${MONGO_ROOT_PASSWORD}@db_mongo:${MONGO_PORT}
    ports:
      - ${GO_FIBER_PORT}:3000
    networks:
      - mongo
      - redis
    restart: always

networks:
  mongo:
    driver: bridge
  redis:
    driver: bridge